<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Pixel Art Generator</title>
    <link rel="icon" href="favicon.ico" />
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: system-ui, sans-serif;
      background: #f7f7f7;
    }
    #app {
      text-align: center;
    }
    #controls {
      margin-bottom: 1rem;
    }
    #prompt {
      width: 260px;
      padding: 0.5rem;
      font-size: 1rem;
    }
    #generate {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      margin-left: 0.5rem;
    }
    #result {
      margin-top: 1rem;
      width: 128px;
      height: 128px;
      image-rendering: pixelated;
      border: 1px solid #ccc;
      background: #fff;
    }
    #log {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #555;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="controls">
      <input id="prompt" type="text" placeholder="예: 집, 나무, 하트" />
      <button id="generate">Generate</button>
    </div>
      <canvas id="result" width="32" height="32"></canvas>
    <div id="log"></div>
  </div>

    <script type="module">
      import { pipeline } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers';

      const log = document.getElementById('log');
      const canvas = document.getElementById('result');
      const ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = false;

      let classifier = null;
      try {
        classifier = await pipeline('zero-shot-classification', 'Xenova/distilbert-base-uncased-mnli');
      } catch (err) {
        console.error('Failed to load model, falling back to keyword match', err);
      }

    const templates = {
      heart: {
        size: 8,
        palette: { '1': '#e74c3c' },
        data: [
          '01100110',
          '11111111',
          '11111111',
          '11111111',
          '01111110',
          '00111100',
          '00011000',
          '00000000'
        ]
      },
      tree: {
        size: 8,
        palette: { '1': '#27ae60', '2': '#8e5b3a' },
        data: [
          '00010000',
          '00111000',
          '01111100',
          '00111000',
          '00111000',
          '00020000',
          '00020000',
          '00020000'
        ]
      },
      house: {
        size: 8,
        palette: { '1': '#c0392b', '2': '#bdc3c7', '3': '#2980b9' },
        data: [
          '00010000',
          '00111000',
          '01111100',
          '11111111',
          '22222222',
          '22233222',
          '22233222',
          '22222222'
        ]
      }
    };

    function getCoords(template) {
      const { size, palette, data } = template;
      const coords = [];
      for (let y = 0; y < size; y++) {
        const row = data[y];
        for (let x = 0; x < size; x++) {
          const code = row[x];
          if (code !== '0') {
            coords.push({ x, y, color: palette[code] });
          }
        }
      }
      return coords;
    }

    function draw(coords, size) {
      const pixel = canvas.width / size;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      coords.forEach(p => {
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x * pixel, p.y * pixel, pixel, pixel);
      });
    }

    function keywordClassify(text) {
      const t = text.toLowerCase();
      if (t.includes('heart') || t.includes('하트') || t.includes('심장')) return 'heart';
      if (t.includes('tree') || t.includes('나무')) return 'tree';
      if (t.includes('house') || t.includes('집')) return 'house';
      return null;
    }

    document.getElementById('generate').addEventListener('click', async () => {
      const text = document.getElementById('prompt').value.trim();
      if (!text) return;
      let label = 'heart';
      if (classifier) {
        try {
          const result = await classifier(text, Object.keys(templates));
          label = result.labels[0];
        } catch (err) {
          console.error('Classification failed, using keywords', err);
          label = keywordClassify(text) || 'heart';
        }
      } else {
        label = keywordClassify(text) || 'heart';
      }
      const template = templates[label];
      const coords = getCoords(template);
      draw(coords, template.size);
      log.textContent = `${label}: ${JSON.stringify(coords)}`;
    });
  </script>
</body>
</html>
